<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google</title>
    <link rel="icon" href="https://github.com/crobperson/Overpriced-Haircut/blob/main/favicon.png?raw=true" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            /* Sizing & Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --container-max-width: 900px;
            --sidebar-width: 260px;
            --app-max-height: 95vh;

            /* Typography */
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'Roboto Mono', monospace;
            --fs-sm: 0.875rem; /* 14px */
            --fs-base: 1rem;    /* 16px */
            --fs-md: 1.125rem; /* 18px */
            --fs-lg: 1.25rem;  /* 20px */
            --fw-regular: 400;
            --fw-medium: 500;
            --fw-semibold: 600;
            --fw-bold: 700;
            --lh-base: 1.6;

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-medium: 300ms ease;
        }

        [data-theme="light"] {
            --bg-primary: #f7f8fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f3f5;
            --bg-overlay: rgba(33, 37, 41, 0.5);
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-tertiary: #adb5bd;
            --border-primary: #dee2e6;
            --border-secondary: #e9ecef;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --accent-primary: #007bff;
            --accent-primary-hover: #0069d9;
            --accent-primary-active: #005cbf;
            --accent-primary-text: #ffffff;
            --accent-secondary: #e7f3ff;
            --user-msg-bg: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-hover));
            --user-msg-text: #ffffff;
            --bot-msg-bg: var(--bg-tertiary);
            --bot-msg-text: var(--text-primary);
            --icon-fill: #495057;
            --icon-fill-hover: var(--text-primary);
            --code-bg: #212529;
            --code-text: #f8f9fa;
            --code-header-bg: #343a40;
            --scrollbar-thumb: #ced4da;
            --scrollbar-track: var(--bg-tertiary);
        }

        [data-theme="dark"] {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2a2a2a;
            --bg-overlay: rgba(0, 0, 0, 0.7);
            --text-primary: #e9ecef;
            --text-secondary: #adb5bd;
            --text-tertiary: #6c757d;
            --border-primary: #3c3c3c;
            --border-secondary: #2c2c2c;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
            --accent-primary: #3b82f6;
            --accent-primary-hover: #60a5fa;
            --accent-primary-active: #2563eb;
            --accent-primary-text: #ffffff;
            --accent-secondary: #252c3b;
            --user-msg-bg: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-active));
            --user-msg-text: #ffffff;
            --bot-msg-bg: var(--bg-tertiary);
            --bot-msg-text: var(--text-primary);
            --icon-fill: #969ba1;
            --icon-fill-hover: var(--text-primary);
            --code-bg: #161616;
            --code-text: #d4d4d4;
            --code-header-bg: #2a2a2a;
            --scrollbar-thumb: #495057;
            --scrollbar-track: var(--bg-tertiary);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {
            font-family: var(--font-main);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: var(--fs-base);
            line-height: var(--lh-base);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--space-md);
        }
        img { max-width: 100%; display: block; }
        button, input, select, textarea { font: inherit; color: inherit; }
        :focus-visible { outline: 2px solid var(--accent-primary); outline-offset: 2px; border-radius: var(--radius-sm); }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; border: 2px solid var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        .main-layout {
            display: flex;
            width: 100%;
            height: 100%;
            max-height: var(--app-max-height);
            max-width: calc(var(--container-max-width) + var(--sidebar-width));
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        /* Chat History Sidebar */
        #chat-history-sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-primary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: margin-left var(--transition-medium);
        }
        .sidebar-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border-primary);
        }
        #new-chat-btn {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #chat-history-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: var(--space-sm);
            list-style: none;
        }
        .chat-history-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background-color var(--transition-fast);
            margin-bottom: var(--space-xs);
        }
        .chat-history-item:hover { background-color: var(--bg-tertiary); }
        .chat-history-item.active { background-color: var(--accent-secondary); }
        .chat-title {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: var(--fs-sm);
        }
        .chat-actions button {
            visibility: hidden;
            opacity: 0;
            transition: opacity var(--transition-fast);
        }
        .chat-history-item:hover .chat-actions button,
        .chat-history-item.active .chat-actions button {
            visibility: visible;
            opacity: 1;
        }
        .delete-chat-btn svg { width: 16px; height: 16px; }

        .app-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            width: 100%;
            height: 100%;
            background-color: var(--bg-secondary);
            overflow: hidden;
        }

        /* Header */
        .chat-header {
            padding: var(--space-sm) var(--space-lg);
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-md);
            flex-shrink: 0;
        }
        #sidebar-toggle { display: none; }
        .chat-header-title { font-size: var(--fs-lg); font-weight: var(--fw-bold); }
        .chat-header-controls { display: flex; align-items: center; gap: var(--space-sm); flex-wrap: wrap; }
        .control-group { display: flex; align-items: center; gap: var(--space-sm); font-size: var(--fs-sm); color: var(--text-secondary); }
        .control-group label { font-weight: var(--fw-medium); }

        /* Main Chat Area */
        #chat-container {
            flex: 1;
            padding: var(--space-lg);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-wrapper { display: flex; gap: var(--space-md); max-width: 85%; animation: fadeInUp 0.4s ease-out; }
        .message-wrapper.user { align-self: flex-end; flex-direction: row-reverse; }
        .message-wrapper.bot { align-self: flex-start; }
        .avatar {
            width: 40px; height: 40px; border-radius: 50%;
            flex-shrink: 0; background-color: var(--border-primary);
            display: flex; align-items: center; justify-content: center;
            font-weight: var(--fw-semibold); font-size: var(--fs-base);
            margin-top: var(--space-xs);
        }
        .user .avatar { background: var(--user-msg-bg); color: var(--user-msg-text); }
        .bot .avatar { background-image: url('https://github.com/crobperson/Overpriced-Haircut/blob/main/favicon.png?raw=true'); background-size: 60%; background-repeat: no-repeat; background-position: center; background-color: var(--bg-tertiary); }
        .message-content { display: flex; flex-direction: column; gap: var(--space-sm); position: relative; }
        .message-content:hover .message-actions { opacity: 1; }
        .message { padding: var(--space-sm) var(--space-md); word-wrap: break-word; white-space: pre-wrap; border-radius: var(--radius-lg); }
        .user .message { background: var(--user-msg-bg); color: var(--user-msg-text); border-bottom-right-radius: var(--radius-sm); }
        .bot .message { background-color: var(--bot-msg-bg); color: var(--bot-msg-text); border-bottom-left-radius: var(--radius-sm); }
        .message p { margin-bottom: var(--space-sm); }
        .message p:last-child { margin-bottom: 0; }
        .message ul, .message ol { padding-left: var(--space-lg); }
        .message a { color: var(--accent-primary); text-decoration: none; }
        .message a:hover { text-decoration: underline; }
        .message-actions { position: absolute; top: -12px; right: 0; display: flex; gap: var(--space-xs); opacity: 0; transition: opacity var(--transition-fast); }
        .user .message-actions { left: 0; right: auto; }

        /* Code Blocks */
        .bot-message pre {
            background-color: var(--code-bg); color: var(--code-text);
            border-radius: var(--radius-md);
            font-family: var(--font-mono); font-size: var(--fs-sm);
            position: relative; margin: var(--space-sm) 0; border: 1px solid var(--border-primary);
            overflow: hidden;
        }
        .code-header { display: flex; justify-content: space-between; align-items: center; background-color: var(--code-header-bg); padding: var(--space-xs) var(--space-md); }
        .code-language { font-size: 0.8rem; color: var(--text-tertiary); font-weight: var(--fw-medium); }
        .bot-message pre code { display: block; padding: var(--space-md); overflow-x: auto; }
        .bot-message p > code { background-color: var(--accent-secondary); color: var(--accent-primary); padding: 0.2em 0.4em; border-radius: var(--radius-sm); font-size: 0.9em; }

        /* Input Area */
        .chat-input-area { padding: var(--space-md) var(--space-lg); border-top: 1px solid var(--border-primary); background-color: var(--bg-secondary); flex-shrink: 0; }
        .input-wrapper {
            display: flex; flex-direction: column; gap: var(--space-sm);
            background-color: var(--bg-tertiary); border: 1px solid var(--border-primary);
            border-radius: var(--radius-md); padding: var(--space-sm);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }
        .input-wrapper:focus-within { border-color: var(--accent-primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-primary) 25%, transparent); }
        .main-input-controls { display: flex; align-items: flex-end; gap: var(--space-sm); }
        #input-box {
            flex-grow: 1; padding: var(--space-sm); border: none; resize: none;
            outline: 0; background-color: transparent; max-height: 200px;
        }
        #input-box::placeholder { color: var(--text-secondary); }
        #file-input { display: none; }
        #attachment-preview { padding: 0 var(--space-sm); display: none; align-items: center; gap: var(--space-sm); }
        #file-preview-container { display: flex; gap: var(--space-xs); align-items: center; flex-wrap: wrap; }
        .file-preview-image { height: 40px; width: 40px; object-fit: cover; border: 2px solid var(--border-primary); border-radius: var(--radius-sm); }
        #file-names { font-size: var(--fs-sm); color: var(--text-secondary); max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Buttons & Controls */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md); border: 1px solid var(--border-primary);
            background-color: var(--bg-secondary);
            font-weight: var(--fw-medium); font-size: var(--fs-sm);
            cursor: pointer; transition: all var(--transition-fast);
        }
        .btn:hover { background-color: var(--bg-tertiary); border-color: var(--text-tertiary); }
        .btn-primary { background-color: var(--accent-primary); color: var(--accent-primary-text); border-color: var(--accent-primary); }
        .btn-primary:hover { background-color: var(--accent-primary-hover); border-color: var(--accent-primary-hover); }
        .btn-primary:active { background-color: var(--accent-primary-active); border-color: var(--accent-primary-active); }
        .btn-icon {
            width: 40px; height: 40px; padding: 0; border-radius: 50%; border: none;
            background-color: transparent; color: var(--icon-fill);
        }
        .btn-icon:hover { background-color: var(--bg-tertiary); color: var(--icon-fill-hover); }
        .btn-icon svg { width: 22px; height: 22px; }
        .btn:disabled, .btn-icon:disabled, select:disabled { cursor: not-allowed; opacity: 0.5; background-color: var(--bg-tertiary); }
        .btn-primary:disabled { background-color: var(--text-tertiary); border-color: var(--text-tertiary); }
        #send-button svg { fill: currentColor; }
        .copy-btn { background-color: color-mix(in srgb, var(--code-header-bg) 50%, transparent); border: none; color: var(--text-secondary); }
        .copy-btn:hover { background-color: var(--border-primary); color: var(--text-primary); }
        .message-action-btn { background-color: var(--bg-tertiary); border: 1px solid var(--border-primary); width: 28px; height: 28px; }
        .message-action-btn svg { width: 16px; height: 16px; }
        #clear-attachments-btn { width: 24px; height: 24px; font-size: 1.2rem; line-height: 1; }

        /* Form Elements */
        select, input[type="range"] {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: var(--space-sm);
            font-size: var(--fs-sm);
            cursor: pointer;
        }
        select:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-primary) 25%, transparent); }
        #temperature-slider { -webkit-appearance: none; appearance: none; width: 100px; height: 6px; padding: 0; background: var(--border-secondary); outline: none; border-radius: 3px; }
        #temperature-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: var(--accent-primary); cursor: pointer; border-radius: 50%; transition: transform var(--transition-fast); }
        #temperature-slider::-webkit-slider-thumb:hover { transform: scale(1.15); }
        #temperature-value { font-size: var(--fs-sm); color: var(--text-primary); width: 30px; text-align: right; font-weight: var(--fw-medium); }

        /* Typing Indicator & Footer */
        #typing-indicator {
            padding: var(--space-sm) var(--space-lg); font-style: italic; color: var(--text-secondary);
            background-color: var(--bg-secondary); border-top: 1px solid var(--border-primary);
            display: none; font-size: var(--fs-sm);
        }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
        #typing-indicator::after { content: '...'; animation: dots 1.5s infinite; display: inline-block; width: 20px; text-align: left; }
        .app-footer { font-size: 0.75rem; text-align: center; color: var(--text-secondary); padding: var(--space-sm); }

        /* Modal */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: var(--bg-overlay);
            align-items: center; justify-content: center;
            animation: fadeIn var(--transition-medium);
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            background-color: var(--bg-secondary);
            width: 90%; max-width: 600px; border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            animation: slideIn var(--transition-medium);
            display: flex; flex-direction: column;
            max-height: 80vh;
        }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: var(--space-lg); border-bottom: 1px solid var(--border-primary); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: var(--fs-lg); font-weight: var(--fw-semibold); }
        .modal-body { padding: var(--space-lg); overflow-y: auto; }
        .modal-footer { padding: var(--space-md) var(--space-lg); border-top: 1px solid var(--border-primary); display: flex; justify-content: flex-end; gap: var(--space-sm); }
        .close-btn {
            font-size: 2rem; font-weight: var(--fw-bold); line-height: 1; cursor: pointer;
            color: var(--text-tertiary); transition: color var(--transition-fast);
            background: none; border: none; padding: 0;
        }
        .close-btn:hover { color: var(--text-primary); }

        /* Settings Modal Specifics */
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: var(--space-md) 0; border-bottom: 1px solid var(--border-primary); }
        .setting-row:last-child { border-bottom: none; }
        .setting-label { font-size: var(--fs-base); color: var(--text-primary); }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: var(--border-primary); transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* System Prompt Modal */
        #system-prompt-textarea { width: 100%; min-height: 120px; resize: vertical; background-color: var(--bg-tertiary); border: 1px solid var(--border-primary); border-radius: var(--radius-md); padding: var(--space-sm); }

        /* Utility & Misc */
        .popup-message {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            background-color: var(--code-bg); color: var(--code-text); padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md); z-index: 2000; opacity: 0;
            transition: opacity var(--transition-medium), bottom var(--transition-medium);
            box-shadow: var(--shadow-md); font-weight: var(--fw-medium);
        }
        .popup-message.show { opacity: 1; bottom: var(--space-lg); }
        .user-message .images-container { display: flex; flex-wrap: wrap; gap: var(--space-sm); margin-top: var(--space-sm); justify-content: flex-end; }
        .message-image { max-width: 150px; max-height: 150px; cursor: pointer; border: 2px solid var(--border-primary); border-radius: var(--radius-md); }
        .generated-message-image { max-width: 100%; max-height: 500px; margin-top: var(--space-sm); border: 2px solid var(--border-primary); border-radius: var(--radius-md); object-fit: contain; }
        #overlay-image { display: none; position: fixed; inset: 0; background-size: cover; background-position: center; background-color: rgba(0,0,0,0.5); z-index: 1001; cursor: pointer; }
        #overlay-image.show { display: block; }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-layout {
                max-width: 100%;
                max-height: 100vh;
                border-radius: 0;
                border: none;
            }
            #chat-history-sidebar {
                position: absolute;
                z-index: 1100;
                height: 100%;
                margin-left: calc(-1 * var(--sidebar-width));
                box-shadow: var(--shadow-md);
            }
            #chat-history-sidebar.show {
                margin-left: 0;
            }
            #sidebar-toggle {
                display: inline-flex;
            }
        }
        @media (max-width: 768px) {
            body { padding: 0; }
            .main-layout { height: 100vh; }
            .chat-header { padding: var(--space-sm) var(--space-md); flex-direction: column; align-items: stretch; gap: var(--space-sm); }
            .chat-header-title { text-align: center; }
            .chat-header-controls { justify-content: space-around; }
            #chat-container { padding: var(--space-md); }
            .chat-input-area { padding: var(--space-sm) var(--space-md); }
            .message-wrapper { max-width: 95%; }
            .modal-content { margin: 5% auto; }
        }
    </style>
</head>
<body>

<div class="main-layout">
    <aside id="chat-history-sidebar">
        <div class="sidebar-header">
            <button id="new-chat-btn" class="btn">
                <span>New Chat</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
            </button>
        </div>
        <ul id="chat-history-list"></ul>
    </aside>

    <div class="app-container">
        <header class="chat-header">
            <button id="sidebar-toggle" class="btn-icon" aria-label="Toggle history" title="Toggle history">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
            <div class="chat-header-title">Clifton AI</div>
            <div class="chat-header-controls">
                <div class="control-group">
                    <label for="model-select">Model:</label>
                    <select id="model-select">
                        <option value="gemini-2.5-flash">Clifton Flash</option>
                        <option value="gemini-2.5-pro">Clifton Pro</option>
                        <option value="gemini-2.0-flash-preview-image-generation">Clifton Image Gen</option>
                    </select>
                </div>
                <div class="control-group" id="temperature-control-group">
                    <label for="temperature-slider">Temp:</label>
                    <input id="temperature-slider" type="range" max="1" min="0" step="0.1" value="1">
                    <span id="temperature-value">1.0</span>
                </div>
            </div>
            <nav class="chat-header-controls" aria-label="Chat actions">
                <button id="theme-toggle-button" class="btn-icon" aria-label="Toggle theme" title="Toggle theme">
                    <!-- Icon will be set by JS -->
                </button>
                <button id="system-prompt-button" class="btn-icon" aria-label="Set system prompt" title="Set system prompt">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                </button>
                <button id="regenerate-button" class="btn-icon" aria-label="Regenerate last response" title="Regenerate last response">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                </button>
                <button id="settings-button" class="btn-icon" aria-label="Settings" title="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
                <button id="changelog-button" class="btn">Changelog</button>
            </nav>
        </header>
        
        <main id="chat-container"></main>
        
        <div id="typing-indicator">Clifton is typing</div>
        
        <footer class="chat-input-area">
            <div class="input-wrapper">
                <div id="attachment-preview">
                    <div id="file-preview-container"></div>
                    <span id="file-names"></span>
                    <button id="clear-attachments-btn" class="btn-icon" title="Clear attachments" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="main-input-controls">
                    <label for="file-input" class="btn-icon file-upload-label" aria-label="Attach files" title="Attach files">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                    </label>
                    <input id="file-input" type="file" accept=".html,image/*,application/pdf,audio/*" multiple>
                    <textarea id="input-box" placeholder="Enter your message..." rows="1"></textarea>
                    <button id="stop-generating-button" class="btn-icon" aria-label="Stop generating" title="Stop generating" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"></path></svg>
                    </button>
                    <button id="send-button" class="btn-icon" aria-label="Send message" title="Send message" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                    </button>
                </div>
            </div>
            <div class="app-footer">Clifton® is not affiliated with Google in any way.</div>
        </footer>
    </div>
</div>

<div id="popup-container"></div>

<!-- Modals -->
<div class="modal" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="settingsModalTitle">Settings</h2>
            <button class="close-btn settings-close" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="setting-row">
                <span class="setting-label">Automatic Scrolling</span>
                <label class="switch">
                    <input type="checkbox" id="auto-scroll-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-row" id="thinking-control-container" style="display: none;">
                <span class="setting-label">Disable Thinking (Flash)</span>
                <label class="switch">
                    <input type="checkbox" id="disable-thinking-checkbox">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="systemPromptModal" role="dialog" aria-modal="true" aria-labelledby="systemPromptModalTitle">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="systemPromptModalTitle">System Prompt</h2>
            <button class="close-btn system-prompt-close" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <p style="font-size: var(--fs-sm); color: var(--text-secondary); margin-bottom: var(--space-md);">Set a persistent instruction for the AI. This will be included at the start of every new conversation.</p>
            <textarea id="system-prompt-textarea" placeholder="e.g., You are a helpful assistant that always responds in Markdown."></textarea>
        </div>
        <div class="modal-footer">
            <button id="save-system-prompt" class="btn btn-primary">Save</button>
        </div>
    </div>
</div>

<div class="modal" id="changelogModal" role="dialog" aria-modal="true" aria-labelledby="changelogModalTitle">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="changelogModalTitle">Changelog</h2>
            <button class="close-btn changelog-close" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <p><strong>Version 2.2 (May 11, 2025)</strong><br>- Added automatic chat saving and history, similar to ChatGPT.</p>
            <p><strong>Version 2.1 (May 10, 2025)</strong><br>- Added Image Generation model (Clifton Image Gen). Supports text-to-image and image-to-image (editing by uploading an image with your prompt).</p>
            <p><strong>Version 2.0 (May 9, 2025)</strong><br>- Revamped the S**tty UI.</p>
            <p><strong>Version 1.83 (April 9, 2025)</strong><br>- Added Image Previews Along With General Improvements</p>
            <p><strong>Version 1.82 (March 31, 2025)</strong><br>- Improved the Clifton pro and flash model (I like chicken)</p>
            <p><strong>Version 1.81 (Feb 6, 2025)</strong><br>- Improved the Clifton pro model (I've ran out of ideas)</p>
            <p><strong>Version 1.8 (January 31, 2025)</strong><br>- Press ctrl 3 times</p>
            <p><strong>Version 1.7 (January 22, 2025)</strong><br>- The Thinker is back... (Currently the best model)</p>
            <p><strong>Version 1.65 (January 16, 2025)</strong><br>- Message Regeneration</p>
            <p><strong>Version 1.6 (January 14, 2025)</strong><br>- Fixed bug!!!</p>
        </div>
    </div>
</div>

<div id="overlay-image" style="background-image: url('https://github.com/crobperson/Overpriced-Haircut/blob/main/Screenshot.png?raw=true');"></div>

<script>
'use strict';

// --- DOM ELEMENTS ---
const dom = {
    chatContainer: document.getElementById("chat-container"),
    inputBox: document.getElementById("input-box"),
    sendButton: document.getElementById("send-button"),
    stopGeneratingButton: document.getElementById("stop-generating-button"),
    typingIndicator: document.getElementById("typing-indicator"),
    modelSelect: document.getElementById("model-select"),
    fileInput: document.getElementById("file-input"),
    popupContainer: document.getElementById("popup-container"),
    fileNamesSpan: document.getElementById("file-names"),
    filePreviewContainer: document.getElementById("file-preview-container"),
    attachmentPreview: document.getElementById('attachment-preview'),
    clearAttachmentsBtn: document.getElementById('clear-attachments-btn'),
    tempSlider: document.getElementById("temperature-slider"),
    tempValueDisplay: document.getElementById("temperature-value"),
    thinkingControlContainer: document.getElementById("thinking-control-container"),
    disableThinkingCheckbox: document.getElementById("disable-thinking-checkbox"),
    regenerateButton: document.getElementById("regenerate-button"),
    themeToggleButton: document.getElementById("theme-toggle-button"),
    systemPromptTextarea: document.getElementById('system-prompt-textarea'),
    overlayImage: document.getElementById('overlay-image'),
    temperatureControlGroup: document.getElementById('temperature-control-group'),
    sidebar: document.getElementById('chat-history-sidebar'),
    sidebarToggle: document.getElementById('sidebar-toggle'),
    newChatBtn: document.getElementById('new-chat-btn'),
    chatHistoryList: document.getElementById('chat-history-list'),
};

// --- STATE MANAGEMENT ---
const appState = {
    history: [],
    currentModel: "gemini-2.5-flash",
    temperature: 1.0,
    isLoading: false,
    debugMode: false,
    autoScroll: true,
    disableThinking: false,
    systemPrompt: '',
    attachedRawFiles: [],
    currentImagePreviews: [],
    lastApiCallInput: null,
    lastBotMessageElement: null,
    lastBotResponseStatus: null,
    apiAbortController: null,
    allChats: {},
    currentChatId: null,
    lastWorkingApiKey: null,
};

// --- API & CONSTANTS ---
const API_KEYS_BINARY = ["01000001 01001001 01111010 01100001 01010011 01111001 01000011 01010001 01110001 01111001 01101010 00110111 01000001 01001101 00111001 01010101 00111000 01011010 01100001 01001100 01010000 01001000 01000111 01011001 00110000 01100100 01110110 01100111 01110101 00110000 01101000 01000101 00110011 01101111 01110010 00110101 01010111 01000011 01100011","01000001 01001001 01111010 01100001 01010011 01111001 01000001 01001110 01100100 01011010 01110001 01001110 01111010 01101000 01001010 01010100 00110010 01110101 00110110 01011000 01001111 01101010 01000001 01111010 01001001 01010010 00110001 01100001 00101101 00110101 00101101 01101110 01001110 01110101 01000111 01100011 01100010 01110110 00110100","01000001 01001001 01111010 01100001 01010011 01111001 01000001 01100101 01011010 01100010 01000110 01101100 01001011 00110001 01100001 01001111 00110101 01110101 01010100 01000011 00110001 01001000 01111000 01010101 01011111 01000100 01000110 01010001 00111000 00110111 01110001 01101111 01010110 00110111 01111001 00101101 01000100 01000101 01110111","01000001 01001001 01111010 01100001 01010011 01111001 01000011 01101001 01100111 01101100 01011010 01110010 01101000 01100011 01100001 00101101 01001111 01010011 01001010 01010011 01010100 00110011 01100111 01000100 01010110 01110100 00111000 01111000 01100100 01001101 01010111 01110110 01000111 01110111 01010001 01000111 01001100 00110100 00110100","01000001 01001001 01111010 01100001 01010011 01111001 01000011 01011000 01001100 01011001 01001101 01101100 00111000 00110011 01000011 00110100 00111001 01101000 00110001 01001101 01010010 00110010 01110001 01010101 01100101 01010100 01010011 01010110 01101110 01101010 01000110 01001001 01110111 01100111 01010011 00110100 01101110 01011111 01100111","01000001 01001001 01111010 01100001 01010011 01111001 01000010 01100011 01110001 01101101 01010110 01010100 00111000 01000001 01100010 01010101 01001111 01101110 01100010 00111000 01000011 01110100 01101000 01001000 01001010 01011000 01001001 01010010 01101000 01100101 01100011 00110100 01110000 00101101 01011010 01101010 01100100 00110010 01010101"];
const API_BASE_URL = "https://generativelanguage.googleapis.com";
const API_KEYS = API_KEYS_BINARY.map(binaryToString);
const ICONS = {
    moon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
    sun: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`
};

// --- UTILITY FUNCTIONS ---
function binaryToString(binary) {
    binary = binary.replace(/[^01]/g, "");
    let text = "";
    for (let i = 0; i < binary.length; i += 8) {
        let byte = binary.substring(i, i + 8);
        if (byte.length === 8) {
            text += String.fromCharCode(parseInt(byte, 2));
        }
    }
    return text;
}

function showPopup(message) {
    const popup = document.createElement("div");
    popup.className = "popup-message";
    popup.textContent = message;
    dom.popupContainer.appendChild(popup);
    requestAnimationFrame(() => popup.classList.add("show"));
    setTimeout(() => {
        popup.classList.remove("show");
        popup.addEventListener('transitionend', () => popup.remove(), { once: true });
    }, 2500);
}

function scrollToBottom() {
    if (appState.autoScroll) {
        dom.chatContainer.scrollTop = dom.chatContainer.scrollHeight;
    }
}

function updateSendButtonState() {
    const hasText = dom.inputBox.value.trim().length > 0;
    const hasFiles = appState.attachedRawFiles.length > 0;
    dom.sendButton.disabled = !(hasText || hasFiles) || appState.isLoading;
}

function setLoadingState(isLoading) {
    appState.isLoading = isLoading;
    dom.typingIndicator.style.display = isLoading ? 'block' : 'none';
    dom.sendButton.style.display = isLoading ? 'none' : 'inline-flex';
    dom.stopGeneratingButton.style.display = isLoading ? 'inline-flex' : 'none';
    dom.regenerateButton.disabled = isLoading;
    dom.newChatBtn.disabled = isLoading;
    dom.inputBox.disabled = isLoading;
    dom.chatHistoryList.style.pointerEvents = isLoading ? 'none' : 'auto';
    dom.modelSelect.disabled = isLoading;
    updateSendButtonState();
}

// --- CHAT HISTORY MANAGEMENT ---

function saveAllChats() {
    try {
        localStorage.setItem('cliftonAiChats', JSON.stringify(appState.allChats));
        if (appState.currentChatId) {
            localStorage.setItem('cliftonAiLastChatId', appState.currentChatId);
        } else {
            localStorage.removeItem('cliftonAiLastChatId');
        }
    } catch (error) {
        console.error("Failed to save chats to localStorage:", error);
        showPopup("Error: Chat history is too large to save.");
    }
}

function loadAllChats() {
    try {
        const savedChats = localStorage.getItem('cliftonAiChats');
        if (savedChats) {
            appState.allChats = JSON.parse(savedChats);
        }
    } catch (error) {
        console.error("Failed to load chats from localStorage:", error);
        appState.allChats = {};
    }
}

function generateChatTitle(text) {
    const words = text.split(' ');
    return words.slice(0, 5).join(' ') + (words.length > 5 ? '...' : '');
}

function startNewChat() {
    if (appState.isLoading) return;
    appState.history = [];
    appState.currentChatId = null;
    appState.lastApiCallInput = null;
    appState.lastBotMessageElement = null;
    appState.lastBotResponseStatus = null;
    dom.chatContainer.innerHTML = "";
    renderHistorySidebar();
    saveAllChats();
    dom.inputBox.focus();
}

function loadChat(chatId) {
    if (appState.isLoading && appState.currentChatId !== chatId) {
        appState.apiAbortController?.abort();
    }
    if (!appState.allChats[chatId] || appState.currentChatId === chatId) return;
    
    appState.currentChatId = chatId;
    appState.history = appState.allChats[chatId].history;
    rebuildChatUIFromHistory();
    renderHistorySidebar();
    saveAllChats();
}

function deleteChat(chatId) {
    if (!appState.allChats[chatId]) return;
    
    const chatTitle = appState.allChats[chatId].title;
    if (confirm(`Are you sure you want to delete "${chatTitle}"?`)) {
        if (appState.currentChatId === chatId && appState.isLoading) {
            appState.apiAbortController?.abort();
        }
        delete appState.allChats[chatId];
        if (appState.currentChatId === chatId) {
            startNewChat();
        } else {
            renderHistorySidebar();
            saveAllChats();
        }
        showPopup("Chat deleted.");
    }
}

function renderHistorySidebar() {
    dom.chatHistoryList.innerHTML = '';
    const sortedChats = Object.values(appState.allChats).sort((a, b) => b.id - a.id);

    sortedChats.forEach(chat => {
        const li = document.createElement('li');
        li.className = 'chat-history-item';
        li.dataset.chatId = chat.id;
        if (chat.id === appState.currentChatId) {
            li.classList.add('active');
        }

        li.innerHTML = `
            <span class="chat-title">${chat.title}</span>
            <div class="chat-actions">
                <button class="btn-icon delete-chat-btn" title="Delete chat">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
        `;
        dom.chatHistoryList.appendChild(li);
    });
}

function rebuildChatUIFromHistory() {
    dom.chatContainer.innerHTML = '';
    appState.history.forEach(message => {
        if (message.role === 'user') {
            const text = message.parts.find(p => p.text)?.text || '';
            appendMessage('user', text);
        } else if (message.role === 'model') {
            const text = message.parts.find(p => p.text)?.text || '';
            const botMessageWrapper = appendMessage('bot', '');
            const messageDiv = botMessageWrapper.querySelector('.message');
            messageDiv.innerHTML = marked.parse(text);
            messageDiv.dataset.rawText = text;
        }
    });
    addCodeSyntaxHighlighting();
    scrollToBottom();
}


// --- MAIN APPLICATION LOGIC ---

async function sendMessage() {
    const textInput = dom.inputBox.value.trim();
    const files = [...appState.attachedRawFiles];
    const imagePreviews = [...appState.currentImagePreviews];

    if (textInput === "" && files.length === 0) return;

    const userMessageForHistory = { role: "user", parts: [{ text: textInput }] };

    if (!appState.currentChatId) {
        const newChatId = Date.now().toString();
        const title = textInput ? generateChatTitle(textInput) : (files.length > 0 ? `Chat with image${files.length > 1 ? 's' : ''}` : "New Chat");
        appState.currentChatId = newChatId;
        appState.allChats[newChatId] = { id: newChatId, title: title, history: [userMessageForHistory] };
        appState.history = appState.allChats[newChatId].history;
        renderHistorySidebar();
        saveAllChats();
    } else {
        appState.history.push(userMessageForHistory);
        saveAllChats();
    }

    setLoadingState(true);
    appendMessage('user', textInput, imagePreviews);
    clearAttachmentUI();
    dom.inputBox.value = "";
    dom.inputBox.style.height = 'auto';
    updateSendButtonState();

    let apiInput;
    if (appState.currentModel === "gemini-2.0-flash-preview-image-generation") {
        let parts = [];
        if (textInput) parts.push({ text: textInput });
        
        const imageFiles = files.filter(file => file.type.startsWith('image/'));
        const nonImageFilesCount = files.length - imageFiles.length;
        if (nonImageFilesCount > 0) {
            showPopup(`${nonImageFilesCount} non-image file(s) were ignored as they are not supported by this model.`);
        }

        const base64Promises = imageFiles.map(file => fileToBase64(file).catch(error => {
            console.error(`Error converting image ${file.name} to base64:`, error);
            showPopup(`Failed to process image: ${file.name}`);
            return null;
        }));
        const base64Results = await Promise.all(base64Promises);

        base64Results.forEach((base64Data, index) => {
            if (base64Data) {
                parts.push({ inline_data: { mime_type: imageFiles[index].type, data: base64Data } });
            }
        });
        apiInput = { parts };
    } else {
        apiInput = { text: textInput, rawFiles: files, history: [...appState.history] };
    }
    
    appState.lastApiCallInput = { payload: apiInput, model: appState.currentModel };
    
    await getBotResponse(apiInput);
    setLoadingState(false);
}

async function getBotResponse(apiInput) {
    appState.apiAbortController = new AbortController();
    const botMessageWrapper = appendMessage('bot', '<i>Clifton is typing...</i>');
    const botMessageDiv = botMessageWrapper.querySelector('.message');
    appState.lastBotMessageElement = botMessageWrapper;
    appState.lastBotResponseStatus = null;

    let botReplied = false;
    let finalResponseText = "";
    let finalResponseImage = null;

    const orderedApiKeys = getApiKeysInOrder();

    for (const apiKey of orderedApiKeys) {
        try {
            if (appState.currentModel === "gemini-2.0-flash-preview-image-generation") {
                const result = await generateImageApiCall(apiKey, apiInput.parts);
                finalResponseText = result.text;
                finalResponseImage = { base64: result.imageBase64, mimeType: result.imageMimeType };
                botReplied = true;
            } else {
                const stream = await getStandardApiStream(apiKey, apiInput);
                let accumulatedResponse = "";
                botMessageDiv.innerHTML = "";

                for await (const chunk of stream) {
                    accumulatedResponse += chunk;
                    botMessageDiv.innerHTML = marked.parse(accumulatedResponse);
                    scrollToBottom();
                }
                finalResponseText = accumulatedResponse;
                botReplied = true;
            }
            
            if (botReplied) {
                appState.lastWorkingApiKey = apiKey;
                break;
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                botMessageDiv.innerHTML = '<i>Generation stopped.</i>';
                appState.lastBotResponseStatus = "aborted";
                if (appState.history.length > 0 && appState.history[appState.history.length - 1].role === 'user') {
                    appState.history.pop();
                }
                saveAllChats();
                return;
            }
            
            if (appState.debugMode) {
                appendMessage('bot', `API Key Error: ${error.message}`);
            }

        }
    }

    if (botReplied) {
        botMessageDiv.innerHTML = '';
        botMessageDiv.dataset.rawText = finalResponseText;
        let modelPartsForHistory = [];

        if (finalResponseText) {
            const textElement = document.createElement('div');
            textElement.innerHTML = marked.parse(finalResponseText);
            botMessageDiv.appendChild(textElement);
            modelPartsForHistory.push({ text: finalResponseText });
        }
        if (finalResponseImage && finalResponseImage.base64) {
            const imgElement = document.createElement('img');
            imgElement.src = `data:${finalResponseImage.mimeType};base64,${finalResponseImage.base64}`;
            imgElement.className = 'generated-message-image';
            imgElement.alt = "Generated Image";
            botMessageDiv.appendChild(imgElement);
            if (!finalResponseText) modelPartsForHistory.push({ text: "[Image Generated]" });
        }

        if (modelPartsForHistory.length > 0) {
            appState.lastBotResponseStatus = "success";
            appState.history.push({ role: "model", parts: modelPartsForHistory });
            saveAllChats();
        } else {
            botMessageDiv.innerHTML = "<i>Received an empty response.</i>";
            appState.lastBotResponseStatus = "empty";
        }
    } else {
        botMessageDiv.innerHTML = `<span style="color: red;">Error: Unable to process request. All API keys failed.</span>`;
        appState.lastBotResponseStatus = "error";
        if (appState.history.length > 0 && appState.history[appState.history.length - 1].role === 'user') {
            appState.history.pop();
        }
        saveAllChats();
    }
    
    addCodeSyntaxHighlighting();
    scrollToBottom();
}

// --- API CALL HELPERS ---

function getApiKeysInOrder() {
    if (!appState.lastWorkingApiKey) return API_KEYS;
    const keys = [appState.lastWorkingApiKey];
    API_KEYS.forEach(key => {
        if (key !== appState.lastWorkingApiKey) keys.push(key);
    });
    return keys;
}

async function* getStandardApiStream(apiKey, apiInput) {
    let userParts = [];
    if (apiInput.text) userParts.push({ text: apiInput.text });

    const filePromises = apiInput.rawFiles.map(file => uploadFile(file, apiKey)
        .then(uploaded => ({ file_data: { mime_type: file.type, file_uri: uploaded.file.uri } }))
        .catch(err => { 
            console.error(err); 
            return null; 
        })
    );
    userParts.push(...(await Promise.all(filePromises)).filter(Boolean));

    const historyWithSystemPrompt = appState.systemPrompt 
        ? [{ role: "user", parts: [{ text: appState.systemPrompt }] }, { role: "model", parts: [{ text: "Understood." }] }, ...apiInput.history.slice(0, -1)]
        : apiInput.history.slice(0, -1);

    const requestBody = {
        contents: [...historyWithSystemPrompt, { role: "user", parts: userParts }],
        generationConfig: {
            temperature: appState.temperature,
            maxOutputTokens: 65536,
            ...(appState.currentModel === "gemini-2.5-flash" && appState.disableThinking && { thinkingConfig: { thinkingBudget: 0 } })
        },
        safetySettings: [
            { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
            { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
            { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
            { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" },
        ],
    };

    const response = await fetch(`${API_BASE_URL}/v1beta/models/${appState.currentModel}:streamGenerateContent?alt=sse&key=${apiKey}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(requestBody),
        signal: appState.apiAbortController.signal,
    });

    if (!response.ok) {
        const error = new Error(`API request failed: ${response.status} ${response.statusText}`);
        error.status = response.status;
        throw error;
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = "";

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        
        let boundary;
        while ((boundary = buffer.indexOf('\n')) >= 0) {
            const line = buffer.substring(0, boundary).trim();
            buffer = buffer.substring(boundary + 1);
            if (line.startsWith("data:")) {
                try {
                    const json = JSON.parse(line.substring(5));
                    const text = json.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) yield text;
                } catch (e) { console.error("SSE parse error:", e); }
            }
        }
    }
}

async function generateImageApiCall(apiKey, parts) {
    const finalParts = appState.systemPrompt ? [{ text: appState.systemPrompt }, ...parts] : parts;
    const response = await fetch(`${API_BASE_URL}/v1beta/models/${appState.currentModel}:generateContent?key=${apiKey}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            contents: [{ role: "user", parts: finalParts }],
            generationConfig: { responseModalities: ["TEXT", "IMAGE"] },
            safetySettings: [ { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" }, { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" }, { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" }, { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" } ],
        }),
        signal: appState.apiAbortController.signal,
    });
    if (!response.ok) {
        const error = new Error(`Image API failed: ${response.status}`);
        error.status = response.status;
        throw error;
    }
    const data = await response.json();
    const result = { text: "", imageBase64: null, imageMimeType: "image/png" };
    data.candidates?.[0]?.content?.parts?.forEach(part => {
        if (part.text) result.text += part.text;
        if (part.inlineData?.data) {
            result.imageBase64 = part.inlineData.data;
            result.imageMimeType = part.inlineData.mimeType;
        }
    });
    return result;
}

// --- FILE HANDLING ---
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

async function uploadFile(file, apiKey) {
    const startRes = await fetch(`${API_BASE_URL}/upload/v1beta/files?key=${apiKey}`, {
        method: "POST",
        headers: { "X-Goog-Upload-Protocol": "resumable", "X-Goog-Upload-Command": "start", "X-Goog-Upload-Header-Content-Length": file.size.toString(), "X-Goog-Upload-Header-Content-Type": file.type, "Content-Type": "application/json" },
        body: JSON.stringify({ file: { display_name: file.name }})
    });
    if (!startRes.ok) throw new Error(`Upload start failed: ${startRes.status}`);
    const uploadUrl = startRes.headers.get("X-Goog-Upload-URL");
    const uploadRes = await fetch(uploadUrl, { method: "POST", headers: { "X-Goog-Upload-Offset": "0", "X-Goog-Upload-Command": "upload, finalize" }, body: file });
    if (!uploadRes.ok) throw new Error(`Upload failed: ${uploadRes.status}`);
    return await uploadRes.json();
}

function clearAttachmentUI() {
    dom.fileInput.value = "";
    dom.fileNamesSpan.textContent = '';
    dom.filePreviewContainer.innerHTML = '';
    dom.attachmentPreview.style.display = 'none';
    dom.clearAttachmentsBtn.style.display = 'none';
    appState.currentImagePreviews = [];
    appState.attachedRawFiles = [];
    updateSendButtonState();
}

function updateAttachmentUI() {
    dom.fileNamesSpan.textContent = '';
    dom.filePreviewContainer.innerHTML = '';
    appState.currentImagePreviews = [];

    if (appState.attachedRawFiles.length > 0) {
        dom.attachmentPreview.style.display = 'flex';
        dom.clearAttachmentsBtn.style.display = 'inline-flex';
        let nonImageFileNames = [];
        appState.attachedRawFiles.forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = e => {
                    const dataUrl = e.target.result;
                    appState.currentImagePreviews.push({ name: file.name, dataUrl });
                    const img = document.createElement('img');
                    img.src = dataUrl;
                    img.className = 'file-preview-image';
                    dom.filePreviewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            } else {
                nonImageFileNames.push(file.name);
            }
        });
        if (nonImageFileNames.length > 0) dom.fileNamesSpan.textContent = nonImageFileNames.join(', ');
    } else {
        clearAttachmentUI();
    }
    updateSendButtonState();
}

// --- UI & DOM MANIPULATION ---
function appendMessage(role, text, imagePreviews = []) {
    const wrapper = document.createElement("div");
    wrapper.className = `message-wrapper ${role}`;

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    if (role === 'user') avatar.textContent = 'U';

    const contentDiv = document.createElement("div");
    contentDiv.className = "message-content";

    const messageDiv = document.createElement("div");
    messageDiv.className = `message ${role}-message`;
    if (role === 'user') messageDiv.dataset.rawText = text;
    
    if (text) {
        const textElement = document.createElement('p');
        if (role === 'user') {
            textElement.textContent = text;
        } else {
            textElement.innerHTML = text; // Allow HTML for bot messages (e.g., "typing...")
        }
        messageDiv.appendChild(textElement);
    }
    if (imagePreviews.length > 0) {
        const imageContainer = document.createElement('div');
        imageContainer.className = 'images-container';
        imagePreviews.forEach(preview => {
            const img = document.createElement('img');
            img.src = preview.dataUrl;
            img.className = 'message-image';
            img.alt = preview.name;
            imageContainer.appendChild(img);
        });
        messageDiv.appendChild(imageContainer);
    }
    
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'message-actions';
    const copyBtn = document.createElement('button');
    copyBtn.className = 'btn-icon message-action-btn';
    copyBtn.title = 'Copy message';
    copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
    copyBtn.onclick = () => {
        const rawText = messageDiv.dataset.rawText;
        navigator.clipboard.writeText(rawText);
        showPopup('Copied to clipboard!');
    };
    actionsDiv.appendChild(copyBtn);

    contentDiv.appendChild(messageDiv);
    contentDiv.appendChild(actionsDiv);
    wrapper.appendChild(role === 'user' ? contentDiv : avatar);
    wrapper.appendChild(role === 'user' ? avatar : contentDiv);
    dom.chatContainer.appendChild(wrapper);
    scrollToBottom();
    return wrapper;
}

function addCodeSyntaxHighlighting() {
    dom.chatContainer.querySelectorAll(".bot-message pre").forEach(pre => {
        if (pre.querySelector(".code-header")) return;

        const code = pre.querySelector('code');
        if (!code) return;

        const langMatch = code.className.match(/language-(\S+)/);
        const lang = langMatch ? langMatch[1] : 'code';

        const header = document.createElement('div');
        header.className = 'code-header';
        
        const langSpan = document.createElement('span');
        langSpan.className = 'code-language';
        langSpan.textContent = lang;

        const copyBtn = document.createElement('button');
        copyBtn.className = 'btn-icon copy-btn';
        copyBtn.title = 'Copy code';
        copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
        copyBtn.onclick = () => {
            navigator.clipboard.writeText(code.innerText);
            copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
            setTimeout(() => {
                copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
            }, 2000);
        };

        header.appendChild(langSpan);
        header.appendChild(copyBtn);
        pre.insertBefore(header, code);
    });
}

function setupModal(buttonId, modalId, closeClass) {
    const modal = document.getElementById(modalId);
    const btn = document.getElementById(buttonId);
    const span = modal.querySelector(closeClass);
    if (!modal || !btn || !span) return;

    const focusableElementsSelector = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
    let focusableElements, firstFocusableElement, lastFocusableElement;

    const trapFocus = (e) => {
        if (e.key !== 'Tab') return;
        if (e.shiftKey) {
            if (document.activeElement === firstFocusableElement) {
                lastFocusableElement.focus();
                e.preventDefault();
            }
        } else {
            if (document.activeElement === lastFocusableElement) {
                firstFocusableElement.focus();
                e.preventDefault();
            }
        }
    };

    const openModal = () => {
        modal.style.display = "flex";
        focusableElements = Array.from(modal.querySelectorAll(focusableElementsSelector));
        firstFocusableElement = focusableElements[0];
        lastFocusableElement = focusableElements[focusableElements.length - 1];
        modal.addEventListener('keydown', trapFocus);
        firstFocusableElement?.focus();
    };

    const closeModal = () => {
        modal.style.display = "none";
        modal.removeEventListener('keydown', trapFocus);
        btn.focus();
    };

    btn.onclick = openModal;
    span.onclick = closeModal;
    window.addEventListener('click', (event) => { if (event.target == modal) closeModal(); });
    modal.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
}

// --- SETTINGS & PERSISTENCE ---
function saveSettings() {
    const settings = {
        autoScroll: appState.autoScroll,
        disableThinking: appState.disableThinking,
        theme: document.documentElement.getAttribute('data-theme'),
        systemPrompt: appState.systemPrompt,
    };
    localStorage.setItem('cliftonAiSettings', JSON.stringify(settings));
}

function updateThemeIcon(theme) {
    dom.themeToggleButton.innerHTML = theme === 'dark' ? ICONS.sun : ICONS.moon;
}

function loadSettings() {
    const saved = localStorage.getItem('cliftonAiSettings');
    let theme;
    if (saved) {
        const settings = JSON.parse(saved);
        appState.autoScroll = settings.autoScroll ?? true;
        appState.disableThinking = settings.disableThinking ?? false;
        appState.systemPrompt = settings.systemPrompt ?? '';
        document.getElementById('auto-scroll-toggle').checked = appState.autoScroll;
        dom.disableThinkingCheckbox.checked = appState.disableThinking;
        dom.systemPromptTextarea.value = appState.systemPrompt;
        theme = settings.theme;
    }
    
    const finalTheme = theme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', finalTheme);
    updateThemeIcon(finalTheme);
}

// --- EVENT LISTENERS ---
function initializeEventListeners() {
    dom.sendButton.addEventListener("click", sendMessage);
    dom.inputBox.addEventListener("keydown", e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }});
    dom.inputBox.addEventListener('input', () => {
        dom.inputBox.style.height = 'auto';
        dom.inputBox.style.height = `${dom.inputBox.scrollHeight}px`;
        updateSendButtonState();
    });
    dom.stopGeneratingButton.addEventListener('click', () => {
        appState.apiAbortController?.abort();
        setLoadingState(false);
    });
    dom.modelSelect.addEventListener("change", () => {
        appState.currentModel = dom.modelSelect.value;
        const isImageModel = appState.currentModel === "gemini-2.0-flash-preview-image-generation";
        dom.temperatureControlGroup.style.display = isImageModel ? 'none' : 'flex';
        dom.thinkingControlContainer.style.display = appState.currentModel === "gemini-2.5-flash" ? 'flex' : 'none';
        
        if (isImageModel) {
            appState.attachedRawFiles = appState.attachedRawFiles.filter(f => f.type.startsWith('image/'));
            updateAttachmentUI();
        }
    });
    dom.tempSlider.addEventListener("input", () => {
        appState.temperature = parseFloat(dom.tempSlider.value);
        dom.tempValueDisplay.textContent = appState.temperature.toFixed(1);
    });
    dom.disableThinkingCheckbox.addEventListener('change', (e) => {
        appState.disableThinking = e.target.checked;
        saveSettings();
    });
    dom.newChatBtn.addEventListener("click", startNewChat);
    dom.regenerateButton.addEventListener("click", async () => {
        if (!appState.lastApiCallInput || appState.isLoading) {
            showPopup("Nothing to regenerate or already generating.");
            return;
        }
        showPopup("Regenerating response...");
        if (appState.lastBotMessageElement) appState.lastBotMessageElement.remove();

        if (appState.lastBotResponseStatus === "success") {
            const lastModelIndex = appState.history.map(m => m.role).lastIndexOf('model');
            if (lastModelIndex > -1) {
                appState.history.splice(lastModelIndex, 1);
            }
        }
        
        setLoadingState(true);
        const originalModel = appState.currentModel;
        appState.currentModel = appState.lastApiCallInput.model;
        await getBotResponse(appState.lastApiCallInput.payload);
        appState.currentModel = originalModel;
        setLoadingState(false);
    });
    dom.fileInput.addEventListener('change', () => {
        appState.attachedRawFiles = Array.from(dom.fileInput.files);
        updateAttachmentUI();
    });
    dom.clearAttachmentsBtn.addEventListener('click', clearAttachmentUI);
    dom.themeToggleButton.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        updateThemeIcon(newTheme);
        saveSettings();
    });
    document.getElementById('auto-scroll-toggle').addEventListener('change', (e) => {
        appState.autoScroll = e.target.checked;
        saveSettings();
    });
    document.getElementById('save-system-prompt').addEventListener('click', () => {
        appState.systemPrompt = dom.systemPromptTextarea.value.trim();
        saveSettings();
        showPopup('System prompt saved.');
        document.getElementById('systemPromptModal').style.display = 'none';
    });

    // History Sidebar Listeners
    dom.sidebarToggle.addEventListener('click', () => dom.sidebar.classList.toggle('show'));
    dom.chatHistoryList.addEventListener('click', (e) => {
        const item = e.target.closest('.chat-history-item');
        if (!item) return;

        const chatId = item.dataset.chatId;
        if (e.target.closest('.delete-chat-btn')) {
            deleteChat(chatId);
        } else {
            loadChat(chatId);
            if (window.innerWidth <= 1024) {
                dom.sidebar.classList.remove('show');
            }
        }
    });
    document.addEventListener('click', (e) => {
        if (window.innerWidth <= 1024 && dom.sidebar.classList.contains('show')) {
            if (!dom.sidebar.contains(e.target) && !dom.sidebarToggle.contains(e.target)) {
                dom.sidebar.classList.remove('show');
            }
        }
    });

    // Easter Egg & Debug
    let ctrlCount = 0, ctrlTimeout;
    document.addEventListener('keydown', e => {
        if (e.altKey && e.shiftKey && e.key === 'E') {
            appState.debugMode = !appState.debugMode;
            showPopup(`Debug mode ${appState.debugMode ? "enabled" : "disabled"}.`);
        }
        if (e.key === 'Control' || e.key === 'Meta') {
            ctrlCount++;
            clearTimeout(ctrlTimeout);
            if (ctrlCount >= 3) {
                ctrlCount = 0;
                dom.overlayImage.classList.toggle('show');
            } else {
                ctrlTimeout = setTimeout(() => { ctrlCount = 0; }, 500);
            }
        } else if (!e.ctrlKey && !e.metaKey) {
            ctrlCount = 0;
        }
    });
    dom.overlayImage.addEventListener('click', () => dom.overlayImage.classList.remove('show'));
}

// --- INITIALIZATION ---
function initializeApp() {
    loadSettings();
    loadAllChats();
    renderHistorySidebar();

    const lastChatId = localStorage.getItem('cliftonAiLastChatId');
    if (lastChatId && appState.allChats[lastChatId]) {
        loadChat(lastChatId);
    } else {
        startNewChat();
    }

    updateSendButtonState();
    initializeEventListeners();
    setupModal('changelog-button', 'changelogModal', '.changelog-close');
    setupModal('settings-button', 'settingsModal', '.settings-close');
    setupModal('system-prompt-button', 'systemPromptModal', '.system-prompt-close');
    
    const isImageModel = dom.modelSelect.value === "gemini-2.0-flash-preview-image-generation";
    dom.temperatureControlGroup.style.display = isImageModel ? 'none' : 'flex';
    dom.thinkingControlContainer.style.display = dom.modelSelect.value === "gemini-2.5-flash" ? 'flex' : 'none';
}

initializeApp();

</script>
</body>
</html>
